# Multi-stage build for Echoria Next.js frontend
# Build context: repository root (KairosChain_2026/)

# Build stage — use Debian (not Alpine/musl) for lightningcss native binary compatibility
FROM node:22-slim AS builder
WORKDIR /app

# Copy package files and install dependencies
# Do fresh install (no lockfile) to get correct platform-specific native
# binaries (lightningcss, swc) for Linux
COPY Echoria/echoria-web/package.json ./
RUN npm install

# Copy application source
COPY Echoria/echoria-web/ .

# Set API URL for production build
ARG NEXT_PUBLIC_API_URL=/api/v1
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# Use standalone output mode (not static export) because app has dynamic routes [id]
# Disable telemetry during build
ENV NEXT_TELEMETRY_DISABLED=1
RUN sed -i "s|// output: 'export'|output: 'standalone'|" next.config.js \
    && npm run build

# Final stage — lightweight runtime
FROM node:22-slim AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Create non-root user
RUN addgroup --system --gid 1001 nodejs \
    && adduser --system --uid 1001 nextjs

# Copy standalone build output
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# Copy public directory if it exists (create empty one if not)
RUN mkdir -p ./public
COPY --from=builder /app/public* ./public/

USER nextjs

EXPOSE 3000

HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
    CMD node -e "fetch('http://localhost:3000/').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"

# Next.js standalone server
CMD ["node", "server.js"]
