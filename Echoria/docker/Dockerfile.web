# Multi-stage build for Echoria Next.js frontend
# Build context: repository root (KairosChain_2026/)

# Dependencies stage
FROM node:22-alpine AS dependencies
WORKDIR /app
COPY Echoria/echoria-web/package.json Echoria/echoria-web/package-lock.json ./
RUN npm ci

# Build stage
FROM node:22-alpine AS builder
WORKDIR /app

# Copy dependencies
COPY --from=dependencies /app/node_modules ./node_modules
COPY Echoria/echoria-web/ .

# Set API URL for production build
ARG NEXT_PUBLIC_API_URL=/api/v1
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# Enable static export and build
RUN sed -i "s|// output: 'export'|output: 'export'|" next.config.js \
    && npm run build

# Final stage - serve static files via shared volume
FROM nginx:alpine

# Copy static build output
COPY --from=builder /app/out /usr/share/nginx/html

# Minimal nginx config for health check only (main nginx handles routing)
RUN echo 'server { listen 80; location /health { return 200 "ok"; } }' \
    > /etc/nginx/conf.d/default.conf

EXPOSE 80

HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

CMD ["nginx", "-g", "daemon off;"]
